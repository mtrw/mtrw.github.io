<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>The glorious R::data.table</title>

<script src="site_libs/header-attrs-2.21/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/sandstone.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-6.4.0/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.0/css/v4-shims.min.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  { color: #cccccc; background-color: #303030; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffcfaf; } /* Alert */
code span.an { color: #7f9f7f; font-weight: bold; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #dca3a3; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #f0dfaf; } /* ControlFlow */
code span.ch { color: #dca3a3; } /* Char */
code span.cn { color: #dca3a3; font-weight: bold; } /* Constant */
code span.co { color: #7f9f7f; } /* Comment */
code span.cv { color: #7f9f7f; font-weight: bold; } /* CommentVar */
code span.do { color: #7f9f7f; } /* Documentation */
code span.dt { color: #dfdfbf; } /* DataType */
code span.dv { color: #dcdccc; } /* DecVal */
code span.er { color: #c3bf9f; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #c0bed1; } /* Float */
code span.fu { color: #efef8f; } /* Function */
code span.im { } /* Import */
code span.in { color: #7f9f7f; font-weight: bold; } /* Information */
code span.kw { color: #f0dfaf; } /* Keyword */
code span.op { color: #f0efd0; } /* Operator */
code span.ot { color: #efef8f; } /* Other */
code span.pp { color: #ffcfaf; font-weight: bold; } /* Preprocessor */
code span.sc { color: #dca3a3; } /* SpecialChar */
code span.ss { color: #cc9393; } /* SpecialString */
code span.st { color: #cc9393; } /* String */
code span.va { } /* Variable */
code span.vs { color: #cc9393; } /* VerbatimString */
code span.wa { color: #7f9f7f; font-weight: bold; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">CMG Bioinformatics</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="./getting_started.html">Getting Started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    University Computing Resources
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="https://dashboard.hpc.unimelb.edu.au/started/">UoM Spartan Dashboard (Linux cluster for bioinformatics)</a>
    </li>
    <li>
      <a href="https://dashboard.hpc.unimelb.edu.au/karaage/">UoM Karaage (cluster account management)</a>
    </li>
    <li>
      <a href="https://spartan-ood.hpc.unimelb.edu.au/pun/sys/dashboard/batch_connect/sys/RStudio/session_contexts/new">UoM OnDemand Dashboard (R)</a>
    </li>
    <li>
      <a href="https://rcp.research.unimelb.edu.au/home/">UoM Research Computing Portal Dashboard (VM)</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Software Downloads
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="https://www.putty.org/">PuTTy (SSH connection to Spartan)</a>
    </li>
    <li>
      <a href="https://www.nsoftware.com/sftp/drive/download.aspx">SFTP Drive (Access project storage from your desktop or a VM (Windows))</a>
    </li>
  </ul>
</li>
<li>
  <a href="./tutorials.html">Tutorials</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Useful Links
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Format Specifications</a>
      <ul class="dropdown-menu" role="menu">
        <li>
          <a href="https://samtools.github.io/hts-specs/VCFv4.3.pdf">VCF/BCF</a>
        </li>
        <li>
          <a href="https://samtools.github.io/hts-specs/SAMv1.pdf">SAM/BAM</a>
        </li>
        <li>
          <a href="https://asia.ensembl.org/info/website/upload/gff3.html">GFF3</a>
        </li>
        <li>
          <a href="https://asia.ensembl.org/info/website/upload/bed.html">BED</a>
        </li>
      </ul>
    </li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Cheatsheets</a>
      <ul class="dropdown-menu" role="menu">
        <li>
          <a href="https://defkey.com/putty-shortcuts">PuTTy</a>
        </li>
        <li>
          <a href="https://remram44.github.io/regex-cheatsheet/regex.html">REGEX</a>
        </li>
        <li>
          <a href="https://www.metagenomics.wiki/tools/blast/blastn-output-format-6">BLASTn output formatting</a>
        </li>
        <li>
          <a href="https://aperiodic.net/screen/quick_reference">GNU screen</a>
        </li>
        <li>
          <a href="https://devhints.io/vim">Vim</a>
        </li>
        <li>
          <a href="https://www.bash2zsh.com/zsh_refcard/refcard.pdf">Zsh</a>
        </li>
        <li>
          <a href="https://www.samformat.info/sam-format-flag">SAM format flag widget</a>
        </li>
        <li>
          <a href="https://ss64.com/bash/chmod.html">chmod flag widget</a>
        </li>
        <li>
          <a href="https://devhints.io/makefile">make</a>
        </li>
        <li>
          <a href="https://marklodato.github.io/visual-git-guide/index-en.html">git</a>
        </li>
        <li>
          <a href="https://www.samformat.info/sam-format-flag">SAM format flag widget</a>
        </li>
        <li class="dropdown-submenu">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">R</a>
          <ul class="dropdown-menu" role="menu">
            <li>
              <a href="https://github.com/mtrw/tim_r_functions">Tim's functions (github)</a>
            </li>
            <li>
              <a href="https://raw.githubusercontent.com/mtrw/tim_r_functions/master/tim_functions.R">Tim's functions (raw code to `source()`)</a>
            </li>
            <li>
              <a href="https://s3.amazonaws.com/assets.datacamp.com/img/blog/data+table+cheat+sheet.pdf">data.table</a>
            </li>
            <li>
              <a href="https://www.maths.usyd.edu.au/u/UG/SM/STAT3022/r/current/Misc/data-visualization-2.1.pdf">ggplot2 (not cool)</a>
            </li>
            <li>
              <a href="https://r-graph-gallery.com/134-general-plot-parameters-reminder">base::plot (cool) plot parameters</a>
            </li>
            <li>
              <a href="https://r-graph-gallery.com/6-graph-parameters-reminder.html">base::plot (cool) point parameters</a>
            </li>
            <li>
              <a href="https://www.rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf">Rmarkdown</a>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Manuals/Documentation</a>
      <ul class="dropdown-menu" role="menu">
        <li>
          <a href="https://dashboard.hpc.unimelb.edu.au/started/">Spartan HPC Documentation</a>
        </li>
        <li>
          <a href="https://slurm.schedmd.com/sbatch.html">Slurm Sbatch</a>
        </li>
        <li>
          <a href="https://wiki-rcs.unimelb.edu.au/display/RCS/Mediaflux">MediaFlux</a>
        </li>
        <li>
          <a href="https://man7.org/linux/man-pages/man1/sftp.1.html">Linux SFTP</a>
        </li>
        <li>
          <a href="https://www.ncbi.nlm.nih.gov/books/NBK279690/pdf/Bookshelf_NBK279690.pdf">BLAST</a>
        </li>
        <li>
          <a href="https://www.gnu.org/software/gawk/manual/gawk.html">AWK</a>
        </li>
        <li>
          <a href="https://www.bx.psu.edu/~rsharris/lastz/">Lastz</a>
        </li>
        <li>
          <a href="https://evolution.genetics.washington.edu/phylip/phylip.html">PHYLIP</a>
        </li>
        <li>
          <a href="https://adv-r.hadley.nz/">Advanced R</a>
        </li>
        <li>
          <a href="https://bedtools.readthedocs.io/en/latest/index.html">Bedtools</a>
        </li>
        <li>
          <a href="https://zsh-manual.netlify.app/the-z-shell-manual">Zsh</a>
        </li>
        <li>
          <a href="https://zsh.sourceforge.io/Intro/intro_1.html">Zsh -- introductory manual</a>
        </li>
      </ul>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/mtrw">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">The glorious R::data.table</h1>

</div>


<hr />
<div id="what-is-data.table" class="section level1">
<h1>What is <code>data.table</code>?</h1>
<p><code>data.table</code> is an R package designed to make working with
data as easy and efficient as it can possibly be. At a first glance it
appears to update the standard R object <code>data.frame</code>. In case
you haven’t used them, you can still follow this tutorial. Basically
<code>data.frame</code>s are R’s most flexible and broadly used way to
store data with a ‘spreadsheet’ structure, i.e., rows and columns.</p>
<p>But <code>data.table</code> adds a lot of functionality besides just
making data handling infinitely better. And it takes (and perfects)
ideas from all the best data handling tools:</p>
<ul>
<li>You can print tables on screen elegantly better than
<code>tibble</code>.</li>
<li>You can manipulate rows and columns and apply functions over them
(grouping by factors etc.) better than <code>dplyr</code>.</li>
<li>You can effectively run loops better than the various
<code>*ply</code> functions.</li>
<li>You can chain commands like <code>magrittr</code> (though …
<code>magrittr</code> and <a
href="https://ivelasq.rbind.io/blog/understanding-the-r-pipe/">native
pipes</a> are still great and work excellently in tandem with
<code>data.table</code>)</li>
<li>You can query tables with all the power of <code>SQL</code>.</li>
<li>You can merge and join tables with the best of them, including very
useful features like <a
href="https://www.r-bloggers.com/2016/06/understanding-data-table-rolling-joins/">rolling
joins</a>.</li>
<li>You can cast and melt tables better than <code>reshape2</code>.</li>
<li>You can find “overlaps” between regions e.g. of genomic intervals,
like with <code>GRanges</code> …</li>
</ul>
<p>And because it does all this so elegantly, it is <strong>super easy
to learn</strong>. To learn the most important stuff, let’s run an
analysis on some Formula 1 racing data, because, of course.</p>
<p>Follow along in an <a href="./tutorial_Rstart.Rmd">Rstudio
session</a>. Make sure you run the commands, and most importantly,
<em>experiment with them</em>.</p>
<figure>
<img src="images/f1.jpg" title="Ferrari make famously bad strategic decisions. In contrast, learning `data.table` is a flawless race strategy for life." style="width:60%">
<figcaption>
By the time you’ve finished this tutorial you will be wrangling data
faster than Charles Leclerc can drive this Ferrari.
</figcaption>
</figure>
<hr />
</div>
<div id="installation-loading" class="section level1">
<h1>Installation / loading</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#If not already installed: install.packages(&quot;data.table&quot;)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(data.table)</span></code></pre></div>
<hr />
</div>
<div id="reading-and-writing-data" class="section level1">
<h1>Reading and writing data</h1>
<p>The data we’ll work with are from <a
href="https://www.kaggle.com/datasets/rohanrao/formula-1-world-championship-1950-2020">here</a>.
You can also find it on the Spartan storage server at
/data/gpfs/projects/punim1869/shared_data/bioinfo_tutorials/f1.</p>
<div id="text-based-table-formats" class="section level2">
<h2>Text-based table formats</h2>
<p>Most text-based ways of storing data consist of lines of text (one
per row), and a separation character delimiting the column entries of
each row. For example, in the <strong>csv</strong> ([c]omma-[s]eparated
[v]alue) format,
<code>"a","row","with",7,"columns","would","look","like","this"</code>.
Note that in X-separated formats, quote marks are often used to indicate
when a column contains text (c.f., say, numbers) because, to a computer,
numbers and the strings of text characters that represent them are very
different things.</p>
<p>The alternative to text-based data storage is binary files, which is
a topic for another day.</p>
</div>
<div id="fread" class="section level2">
<h2>fread()</h2>
<p><code>data.table</code> has its own table parsing function,
<code>fread()</code> ([f]ast [read]). It assumes you are giving it some
X-separated table and investigates the top of a the file (10,000 lines
by default) and tries to work out what the separator is and what the
kind of data in each column is, then reads it. Use it to read in the
data about lap times, drivers, and races—something like the
following:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>lt <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;data/lapTimes.csv&quot;</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>dr <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;data/drivers.csv&quot;</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>ra <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;data/races.csv&quot;</span>)</span></code></pre></div>
<p>The variables <code>dr</code> and <code>lt</code> now contain
<code>data.table</code> objects. Since these are enhanced
<code>data.frame</code>s, we can do data.frame type things with them,
such as printing the contents by running the variable name alone:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>lt</span></code></pre></div>
<pre><code>##         raceId driverId lap position     time milliseconds
##      1:    841       20   1        1 1:38.109        98109
##      2:    841       20   2        1 1:33.006        93006
##      3:    841       20   3        1 1:32.713        92713
##     ---                                                   
## 426631:    988      825  52       13 1:43.934       103934
## 426632:    988      825  53       13 1:44.164       104164
## 426633:    988      825  54       13 1:44.285       104285</code></pre>
<p>Notice it prints in a useful format showing the top and bottom few
rows (default is five but you can <a
href="https://jangorecki.gitlab.io/data.cube/library/data.table/html/print.data.table.html">play
with it</a>).</p>
<p>There are some useful arguments you can give to <code>fread()</code>
as necessary:</p>
<ul>
<li><code>fread(header=F)</code>
<ul>
<li>Often your tables won’t have a top row containing names. In this
case, tell <code>fread()</code> not to assume the top row is column
labels. It will call the columns <em>“V1”</em>, <em>“V2”</em>, …
<em>“Vn”</em> by default, unless …</li>
</ul></li>
<li><code>fread(col.names=c("names","for","columns","go","in","this","vector"))</code>
<ul>
<li>Obviously, for this to work the vector of column names must equal
the number of columns.</li>
</ul></li>
<li><code>fread(select=1:3)</code>
<ul>
<li>This would read only the first three columns. With
<code>select=c(6,3,5)</code> we would get those columns in that
order.</li>
</ul></li>
</ul>
</div>
<div id="writing-data" class="section level2">
<h2>Writing data</h2>
<p>Is done with the normal R functions like <code>write.csv</code> and
<code>saveRDS</code>.</p>
</div>
</div>
<div id="the-central-concept-three-indexing-fields"
class="section level1">
<h1>The central concept: Three indexing fields</h1>
<p>A <code>data.table</code> is primarily manipulated using a
square-bracket syntax similar to <code>data.frame</code>s. So you can,
for example, provide indices for rows and columns in the first two
arguments to select them, just like regular
<code>data.frame</code>s:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>lt[<span class="dv">5</span>,]</span></code></pre></div>
<pre><code>##    raceId driverId lap position     time milliseconds
## 1:    841       20   5        1 1:32.342        92342</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>lt[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>##    raceId driverId lap position     time milliseconds
## 1:    841       20   1        1 1:38.109        98109
## 2:    841       20   2        1 1:33.006        93006
## 3:    841       20   3        1 1:32.713        92713
## 4:    841       20   4        1 1:32.803        92803
## 5:    841       20   5        1 1:32.342        92342</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>lt[,<span class="dv">1</span>]</span></code></pre></div>
<pre><code>##         raceId
##      1:    841
##      2:    841
##      3:    841
##     ---       
## 426631:    988
## 426632:    988
## 426633:    988</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>lt[,<span class="st">&quot;lap&quot;</span>]</span></code></pre></div>
<pre><code>##         lap
##      1:   1
##      2:   2
##      3:   3
##     ---    
## 426631:  52
## 426632:  53
## 426633:  54</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>lt[,<span class="fu">c</span>(<span class="st">&quot;lap&quot;</span>,<span class="st">&quot;time&quot;</span>)]</span></code></pre></div>
<pre><code>##         lap     time
##      1:   1 1:38.109
##      2:   2 1:33.006
##      3:   3 1:32.713
##     ---             
## 426631:  52 1:43.934
## 426632:  53 1:44.164
## 426633:  54 1:44.285</code></pre>
<p>And you can always use the dollar sign operator <code>$</code> to
extract a column as a vector …</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>dr<span class="sc">$</span>forename[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code></pre></div>
<pre><code>##  [1] &quot;Lewis&quot;    &quot;Nick&quot;     &quot;Nico&quot;     &quot;Fernando&quot; &quot;Heikki&quot;   &quot;Kazuki&quot;  
##  [7] &quot;S̩bastien&quot; &quot;Kimi&quot;     &quot;Robert&quot;   &quot;Timo&quot;</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># or perhaps you prefer ...</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>dr[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]<span class="sc">$</span>forename</span></code></pre></div>
<pre><code>##  [1] &quot;Lewis&quot;    &quot;Nick&quot;     &quot;Nico&quot;     &quot;Fernando&quot; &quot;Heikki&quot;   &quot;Kazuki&quot;  
##  [7] &quot;S̩bastien&quot; &quot;Kimi&quot;     &quot;Robert&quot;   &quot;Timo&quot;</code></pre>
<p>If you want to select specific rows based on some property, you
<em>could</em> use logical vectors (vectors of TRUEs and FALSEs that
indicate whether a row should be selected):</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>selectMe <span class="ot">&lt;-</span> lt<span class="sc">$</span>lap <span class="sc">&lt;</span> <span class="dv">3</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>selectMe[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code></pre></div>
<pre><code>##  [1]  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>lt[selectMe,] <span class="co"># Note now only data for laps 1 and 2 are there</span></span></code></pre></div>
<pre><code>##        raceId driverId lap position     time milliseconds
##     1:    841       20   1        1 1:38.109        98109
##     2:    841       20   2        1 1:33.006        93006
##     3:    841        1   1        2 1:40.573       100573
##    ---                                                   
## 16193:    988      154   2       14 1:47.792       107792
## 16194:    988      825   1       20 2:00.490       120490
## 16195:    988      825   2       20 1:48.699       108699</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(selectMe)  <span class="co"># It&#39;s good to clean up variables you don&#39;t need later to save memory</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Four steps ... really?</span></span></code></pre></div>
<p>… In reality, these operations are rarely used.
<code>data.table</code>’s natural method of doing things is almost
always better. Instead, we think of the indexing operator as having
three fields, that we use for different purposes. We will learn them in
order, but also pick up some other tricks on the way. To begin with,
memorise this:</p>
<blockquote>
<p>dataTable[ &lt;SELECT&gt; , &lt;DO_SOMETHING&gt; , &lt;GROUP_BY&gt;
]</p>
</blockquote>
<div id="the-select-field" class="section level2">
<h2>The [ &lt;SELECT&gt; ,,] field</h2>
<p>While you’re working in the indexing fields, you can simply refer to
column names of the table directly, and they will be treated as vectors.
Which, as far as the computer’s understanding of a table goes, is
exactly what they are.</p>
<p>The output of whatever you write in the SELECT field is used to
(surprise!) select rows. Here are some typical examples:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>lt[lap<span class="sc">&lt;</span><span class="dv">3</span>,]</span></code></pre></div>
<pre><code>##        raceId driverId lap position     time milliseconds
##     1:    841       20   1        1 1:38.109        98109
##     2:    841       20   2        1 1:33.006        93006
##     3:    841        1   1        2 1:40.573       100573
##    ---                                                   
## 16193:    988      154   2       14 1:47.792       107792
## 16194:    988      825   1       20 2:00.490       120490
## 16195:    988      825   2       20 1:48.699       108699</code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>lt[lap<span class="sc">&lt;</span><span class="dv">3</span> <span class="sc">&amp;</span> driverId<span class="sc">==</span><span class="dv">20</span>,]</span></code></pre></div>
<pre><code>##      raceId driverId lap position     time milliseconds
##   1:    841       20   1        1 1:38.109        98109
##   2:    841       20   2        1 1:33.006        93006
##   3:    842       20   1        1 1:49.614       109614
##  ---                                                   
## 379:    987       20   2        1 2:18.392       138392
## 380:    988       20   1        3 1:47.471       107471
## 381:    988       20   2        3 1:43.632       103632</code></pre>
<p>This works because (say) <code>lap&lt;3</code> outputs a logical
vector that is TRUE when lap contains 1 or 2, and FALSE otherwise. But
what you output can also be numbers referring to rows. A classic example
is this trick used to sort the rows by some column …</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>lt[<span class="fu">order</span>(milliseconds),]</span></code></pre></div>
<pre><code>##         raceId driverId lap position        time milliseconds
##      1:    977        1  69        4    1:07.411        67411
##      2:    977        1  65        4    1:07.424        67424
##      3:    977      817  69        3    1:07.442        67442
##     ---                                                      
## 426631:    847      808  25        5 2:05:06.243      7506243
## 426632:    847       13  25        3 2:05:06.656      7506656
## 426633:    847        2  25        4 2:05:07.547      7507547</code></pre>
<p>Note the comma is optional but you should write it anyway for good
reasons that you can ask me about.</p>
<p>Also note in Rstudio you can use <code>&lt;tab&gt;</code> to
autocomplete column names while you work inside the indexing fields.</p>
<div id="special-variable-.n" class="section level3">
<h3>Special variable: <code>.N</code></h3>
<p>Inside the indexing fields, <code>.N</code> always contains the
number of rows of the table (or the group; see later). Hence, to reverse
the table:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>lt[.N<span class="sc">:</span><span class="dv">1</span>,]</span></code></pre></div>
<pre><code>##         raceId driverId lap position     time milliseconds
##      1:    988      825  54       13 1:44.285       104285
##      2:    988      825  53       13 1:44.164       104164
##      3:    988      825  52       13 1:43.934       103934
##     ---                                                   
## 426631:    841       20   3        1 1:32.713        92713
## 426632:    841       20   2        1 1:33.006        93006
## 426633:    841       20   1        1 1:38.109        98109</code></pre>
</div>
<div id="in-and-between" class="section level3">
<h3>%in% and %between%</h3>
<p>These are exceptionally useful for selection:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>lt[lap <span class="sc">%between%</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">7</span>),] <span class="co"># Select laps between (and including) 4 and 7</span></span></code></pre></div>
<pre><code>##        raceId driverId lap position     time milliseconds
##     1:    841       20   4        1 1:32.803        92803
##     2:    841       20   5        1 1:32.342        92342
##     3:    841       20   6        1 1:32.605        92605
##    ---                                                   
## 31714:    988      825   5       20 1:47.197       107197
## 31715:    988      825   6       20 1:46.957       106957
## 31716:    988      825   7       19 1:46.344       106344</code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>lt[lap <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">6</span>,<span class="dv">7</span>),] <span class="co"># Select laps 4, 6 and 7</span></span></code></pre></div>
<pre><code>##        raceId driverId lap position     time milliseconds
##     1:    841       20   4        1 1:32.803        92803
##     2:    841       20   6        1 1:32.605        92605
##     3:    841       20   7        1 1:32.502        92502
##    ---                                                   
## 23760:    988      825   4       20 1:46.760       106760
## 23761:    988      825   6       20 1:46.957       106957
## 23762:    988      825   7       19 1:46.344       106344</code></pre>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>lt[<span class="sc">!</span>lap <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">6</span>,<span class="dv">7</span>),] <span class="co"># Select all laps except 4, 6 and 7</span></span></code></pre></div>
<pre><code>##         raceId driverId lap position     time milliseconds
##      1:    841       20   1        1 1:38.109        98109
##      2:    841       20   2        1 1:33.006        93006
##      3:    841       20   3        1 1:32.713        92713
##     ---                                                   
## 402869:    988      825  52       13 1:43.934       103934
## 402870:    988      825  53       13 1:44.164       104164
## 402871:    988      825  54       13 1:44.285       104285</code></pre>
<p>As you can imagine, this is something you might use to select, say,
genes or SNPs falling within a particular range.</p>
</div>
</div>
<div id="merging" class="section level2">
<h2>Merging</h2>
<p>The SELECT field can also be used for one of<code>data.table</code>’s
most powerful functions, merging tables together. Notice in
<code>lt</code> that the drivers and races are given numbers, not
names.</p>
<p>If you look inside <code>ra</code> and <code>dr</code>, you will
notice these tables allow us to see what number corresponds to what
driver/race.</p>
<p>Merging allows us to use one <code>data.table</code> to look up what
rows of a second <code>data.table</code> it matches according to the
values in some column that occurs in both tables (say, driverId). When
you think about it, it is almost like the rows of one table are
<em>selecting</em> which rows of a second data table to join with. This
is why it makes sense to use the SELECT indexing field for merging.</p>
<p>To do it, we just put the selecting <code>data.table</code> in the
SELECT field of the other <code>data.table</code>, and then add an
argument listing which column(s) to look for matches on.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>dr[lt,on<span class="ot">=</span><span class="fu">list</span>(driverId)]</span></code></pre></div>
<pre><code>##         driverId       driverRef number code  forename   surname        dob
##      1:       20          vettel      5  VET Sebastian    Vettel 03/07/1987
##      2:       20          vettel      5  VET Sebastian    Vettel 03/07/1987
##      3:       20          vettel      5  VET Sebastian    Vettel 03/07/1987
##     ---                                                                    
## 426631:      825 kevin_magnussen     20  MAG     Kevin Magnussen 05/10/1992
## 426632:      825 kevin_magnussen     20  MAG     Kevin Magnussen 05/10/1992
## 426633:      825 kevin_magnussen     20  MAG     Kevin Magnussen 05/10/1992
##         nationality                                           url raceId lap
##      1:      German http://en.wikipedia.org/wiki/Sebastian_Vettel    841   1
##      2:      German http://en.wikipedia.org/wiki/Sebastian_Vettel    841   2
##      3:      German http://en.wikipedia.org/wiki/Sebastian_Vettel    841   3
##     ---                                                                     
## 426631:      Danish  http://en.wikipedia.org/wiki/Kevin_Magnussen    988  52
## 426632:      Danish  http://en.wikipedia.org/wiki/Kevin_Magnussen    988  53
## 426633:      Danish  http://en.wikipedia.org/wiki/Kevin_Magnussen    988  54
##         position     time milliseconds
##      1:        1 1:38.109        98109
##      2:        1 1:33.006        93006
##      3:        1 1:32.713        92713
##     ---                               
## 426631:       13 1:43.934       103934
## 426632:       13 1:44.164       104164
## 426633:       13 1:44.285       104285</code></pre>
<p>Note <code>data.table</code> uses lists often so the dot character
<code>.</code> can be used as a shortcut for the <code>list</code>
function.</p>
<p>Also note you can join on more than one column, just add all the
names to the <code>on=</code> list.</p>
<p>For more flexibility, check the documentation with
<code>?merge.data.table</code>. You’ll find you can do cool things like
return rows that do NOT match. Let’s merge all our driver and race data
into the lap times table and move on.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>lt <span class="ot">&lt;-</span> dr[lt,on<span class="ot">=</span>.(driverId)]</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>lt <span class="ot">&lt;-</span> ra[lt,on<span class="ot">=</span>.(raceId)]</span></code></pre></div>
<p>If you look at <code>lt</code> now, you’ll see what happens when a
column name overlaps between the tables, (besides the one being merged
on; in this case, “url”). <code>data.table</code> automatically renames
one of them (e.g.) “i.url”.</p>
</div>
<div id="the-do_something-field" class="section level2">
<h2>The [, &lt;DO_SOMETHING&gt; ,] field</h2>
<p>The DO_SOMETHING field is where the work gets done. Whether you are
manipulating or adding or deleting columns, making calculations and
returning the results, or even plotting, you do it all here. For
example, you could do some calculation on the columns. Treat columns
just like regular vectors. That’s how the computer thinks of them, so
why shouldn’t you too?</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">#What was the fastest lap?</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>lt[, <span class="fu">min</span>(milliseconds) ]</span></code></pre></div>
<pre><code>## [1] 67411</code></pre>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ... in minutes</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>lt[, <span class="fu">min</span>(milliseconds)<span class="sc">/</span><span class="dv">1000</span><span class="sc">/</span><span class="dv">60</span> ]</span></code></pre></div>
<pre><code>## [1] 1.123517</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ... at an Australian Grand Prix (notice we are now also using the SELECT field)</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>lt[ name<span class="sc">==</span><span class="st">&quot;Australian Grand Prix&quot;</span> , <span class="fu">min</span>(milliseconds)<span class="sc">/</span><span class="dv">1000</span><span class="sc">/</span><span class="dv">60</span> ]</span></code></pre></div>
<pre><code>## [1] 1.402083</code></pre>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ... and what years did Sebastian Vettel race in Australia?</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>lt[ name<span class="sc">==</span><span class="st">&quot;Australian Grand Prix&quot;</span> , <span class="fu">unique</span>(year) ]</span></code></pre></div>
<pre><code>##  [1] 2011 2012 2013 2014 2015 2016 1996 1997 1998 1999 2000 2001 2002 2003 2004
## [16] 2005 2006 2007 2008 2009 2010 2017</code></pre>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ... so what lap was Sebastian Vettel&#39;s fastest lap at the 2011 Australian Grand Prix?</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>lt[ name<span class="sc">==</span><span class="st">&quot;Australian Grand Prix&quot;</span> <span class="sc">&amp;</span> year<span class="sc">==</span><span class="dv">2011</span> <span class="sc">&amp;</span> surname<span class="sc">==</span><span class="st">&quot;Vettel&quot;</span> , lap[<span class="fu">which</span>(milliseconds<span class="sc">==</span><span class="fu">min</span>(milliseconds))] ]</span></code></pre></div>
<pre><code>## [1] 44</code></pre>
<div id="ceci-nest-pas-une-pipe" class="section level3">
<h3>Ceci n’est pas une pipe</h3>
<p>This last line could be cleaner. If we need to filter multiple times,
we can just chain indexing operations together. This can simplify the
above command as follows:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>lt[ name<span class="sc">==</span><span class="st">&quot;Australian Grand Prix&quot;</span> <span class="sc">&amp;</span> year<span class="sc">==</span><span class="dv">2011</span> <span class="sc">&amp;</span> surname<span class="sc">==</span><span class="st">&quot;Vettel&quot;</span> , ][ milliseconds<span class="sc">==</span><span class="fu">min</span>(milliseconds), lap ]</span></code></pre></div>
<pre><code>## [1] 44</code></pre>
<p>Command chaining like this makes <code>data.table</code> function as
a <strong>pipe</strong>! Just like <code>magrittr</code>! Brilliant!</p>
<p>I wonder how this lap compares to his other laps that day? Well, we
could make a quick plot …</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>lt[ name<span class="sc">==</span><span class="st">&quot;Australian Grand Prix&quot;</span> <span class="sc">&amp;</span> year<span class="sc">==</span><span class="dv">2011</span> <span class="sc">&amp;</span> surname<span class="sc">==</span><span class="st">&quot;Vettel&quot;</span> , <span class="fu">plot</span>(<span class="at">x=</span>lap,<span class="at">y=</span>milliseconds<span class="sc">/</span><span class="dv">1000</span><span class="sc">/</span><span class="dv">60</span>) ]</span></code></pre></div>
<p><img src="tutorial_data_table_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<pre><code>## NULL</code></pre>
<p>… looks like he had two pit stops and got faster and faster as the
race went on. Which is good because .. he won! See?</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>lt[ name<span class="sc">==</span><span class="st">&quot;Australian Grand Prix&quot;</span> <span class="sc">&amp;</span> year<span class="sc">==</span><span class="dv">2011</span> <span class="sc">&amp;</span> surname<span class="sc">==</span><span class="st">&quot;Vettel&quot;</span>, ][ lap<span class="sc">==</span><span class="fu">max</span>(lap), <span class="fu">paste</span>(<span class="st">&quot;At the end of the final lap, Vettel was in position&quot;</span>,position,<span class="st">&quot;!&quot;</span>) ]</span></code></pre></div>
<pre><code>## [1] &quot;At the end of the final lap, Vettel was in position 1 !&quot;</code></pre>
</div>
<div id="returning-a-new-data.table" class="section level3">
<h3>Returning a new <code>data.table</code></h3>
<p>Very often, the result you want is another<code>data.table</code>. To
do this, we use the <DO_SOMETHING> should return a list, in a format
like
<code>list( item1_name=&lt;vector&gt; , item2_name=&lt;another vector&gt; )</code>
Each item in the list will become a column. Let’s use it to generate
some summary statistics for all the races together:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Remember, `.()` is a shortcut for `list()`</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>lt[ , .( <span class="at">fastest_race_lap =</span> <span class="fu">min</span>(milliseconds) , <span class="at">number_of_drivers =</span> <span class="fu">length</span>(<span class="fu">unique</span>(driverId)) , <span class="at">average_driver_hours_per_race=</span><span class="fu">sum</span>(milliseconds)<span class="sc">/</span><span class="dv">3600000</span><span class="sc">/</span><span class="fu">length</span>(<span class="fu">unique</span>(driverId)) ) ] </span></code></pre></div>
<pre><code>##    fastest_race_lap number_of_drivers average_driver_hours_per_race
## 1:            67411               123                       92.3044</code></pre>
<p>Note, you can clean this code using multiple lines:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>lt[ , .(</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">fastest_race_lap =</span> <span class="fu">min</span>(milliseconds),</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">number_of_drivers =</span> <span class="fu">length</span>(<span class="fu">unique</span>(driverId)),</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">average_driver_race_hours=</span><span class="fu">sum</span>(milliseconds)<span class="sc">/</span><span class="dv">3600000</span><span class="sc">/</span><span class="fu">length</span>(<span class="fu">unique</span>(driverId))</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>)]</span></code></pre></div>
<p>A common use is to trim your <code>data.table</code> down to just
important columns. Let’s use it now to make a smaller table to look at
in future, one that only includes the Melbourne Grand Prix stats:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co">#(l)ap (t)imes, (A)ustralian GP</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>lt[,<span class="fu">unique</span>(name)] <span class="co"># Just to have a look at the Grand Prix names</span></span></code></pre></div>
<pre><code>##  [1] &quot;Australian Grand Prix&quot;    &quot;Malaysian Grand Prix&quot;    
##  [3] &quot;Chinese Grand Prix&quot;       &quot;Turkish Grand Prix&quot;      
##  [5] &quot;Spanish Grand Prix&quot;       &quot;Monaco Grand Prix&quot;       
##  [7] &quot;Canadian Grand Prix&quot;      &quot;European Grand Prix&quot;     
##  [9] &quot;British Grand Prix&quot;       &quot;German Grand Prix&quot;       
## [11] &quot;Hungarian Grand Prix&quot;     &quot;Belgian Grand Prix&quot;      
## [13] &quot;Italian Grand Prix&quot;       &quot;Singapore Grand Prix&quot;    
## [15] &quot;Japanese Grand Prix&quot;      &quot;Korean Grand Prix&quot;       
## [17] &quot;Indian Grand Prix&quot;        &quot;Abu Dhabi Grand Prix&quot;    
## [19] &quot;Brazilian Grand Prix&quot;     &quot;Bahrain Grand Prix&quot;      
## [21] &quot;United States Grand Prix&quot; &quot;Austrian Grand Prix&quot;     
## [23] &quot;Russian Grand Prix&quot;       &quot;Mexican Grand Prix&quot;      
## [25] &quot;Argentine Grand Prix&quot;     &quot;San Marino Grand Prix&quot;   
## [27] &quot;French Grand Prix&quot;        &quot;Portuguese Grand Prix&quot;   
## [29] &quot;Luxembourg Grand Prix&quot;    &quot;Azerbaijan Grand Prix&quot;</code></pre>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>ltA <span class="ot">&lt;-</span> lt[ name<span class="sc">==</span><span class="st">&quot;Australian Grand Prix&quot;</span>, .(</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  forename,</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  surname,</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  lap,</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  milliseconds,</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  position,</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  name,</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  circuitId,</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>  year</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>)]</span></code></pre></div>
</div>
<div id="adding-or-modifying-columns" class="section level3">
<h3>Adding or modifying columns</h3>
<p>The beautifully-named <em>walrus operator</em> <code>:=</code> is
used to add, modify, or delete columns.</p>
<p>To add:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co">#add two columns using chaining</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>ltA[,seconds<span class="sc">:</span><span class="er">=</span>milliseconds<span class="sc">/</span><span class="dv">1000</span>][,fullname<span class="sc">:</span><span class="er">=</span><span class="fu">paste</span>(forename,surname)]</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>ltA</span></code></pre></div>
<pre><code>##         forename   surname lap milliseconds position                  name
##     1: Sebastian    Vettel   1        98109        1 Australian Grand Prix
##     2: Sebastian    Vettel   2        93006        1 Australian Grand Prix
##     3: Sebastian    Vettel   3        92713        1 Australian Grand Prix
##    ---                                                                    
## 19843:    Daniel Ricciardo  23        90407       17 Australian Grand Prix
## 19844:    Daniel Ricciardo  24        89466       17 Australian Grand Prix
## 19845:    Daniel Ricciardo  25        89708       17 Australian Grand Prix
##        circuitId year seconds         fullname
##     1:         1 2011  98.109 Sebastian Vettel
##     2:         1 2011  93.006 Sebastian Vettel
##     3:         1 2011  92.713 Sebastian Vettel
##    ---                                        
## 19843:         1 2017  90.407 Daniel Ricciardo
## 19844:         1 2017  89.466 Daniel Ricciardo
## 19845:         1 2017  89.708 Daniel Ricciardo</code></pre>
<p>To modify:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co">#replace spaces with underscores in $name</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>ltA[,name<span class="sc">:</span><span class="er">=</span><span class="fu">gsub</span>(<span class="st">&quot; &quot;</span>,<span class="st">&quot;_&quot;</span>,name)]</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>ltA</span></code></pre></div>
<pre><code>##         forename   surname lap milliseconds position                  name
##     1: Sebastian    Vettel   1        98109        1 Australian_Grand_Prix
##     2: Sebastian    Vettel   2        93006        1 Australian_Grand_Prix
##     3: Sebastian    Vettel   3        92713        1 Australian_Grand_Prix
##    ---                                                                    
## 19843:    Daniel Ricciardo  23        90407       17 Australian_Grand_Prix
## 19844:    Daniel Ricciardo  24        89466       17 Australian_Grand_Prix
## 19845:    Daniel Ricciardo  25        89708       17 Australian_Grand_Prix
##        circuitId year seconds         fullname
##     1:         1 2011  98.109 Sebastian Vettel
##     2:         1 2011  93.006 Sebastian Vettel
##     3:         1 2011  92.713 Sebastian Vettel
##    ---                                        
## 19843:         1 2017  90.407 Daniel Ricciardo
## 19844:         1 2017  89.466 Daniel Ricciardo
## 19845:         1 2017  89.708 Daniel Ricciardo</code></pre>
<p>To destroy:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>ltA[,milliseconds<span class="sc">:</span><span class="er">=</span><span class="cn">NULL</span>]</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>ltA</span></code></pre></div>
<pre><code>##         forename   surname lap position                  name circuitId year
##     1: Sebastian    Vettel   1        1 Australian_Grand_Prix         1 2011
##     2: Sebastian    Vettel   2        1 Australian_Grand_Prix         1 2011
##     3: Sebastian    Vettel   3        1 Australian_Grand_Prix         1 2011
##    ---                                                                      
## 19843:    Daniel Ricciardo  23       17 Australian_Grand_Prix         1 2017
## 19844:    Daniel Ricciardo  24       17 Australian_Grand_Prix         1 2017
## 19845:    Daniel Ricciardo  25       17 Australian_Grand_Prix         1 2017
##        seconds         fullname
##     1:  98.109 Sebastian Vettel
##     2:  93.006 Sebastian Vettel
##     3:  92.713 Sebastian Vettel
##    ---                         
## 19843:  90.407 Daniel Ricciardo
## 19844:  89.466 Daniel Ricciardo
## 19845:  89.708 Daniel Ricciardo</code></pre>
</div>
</div>
<div id="the-group_by-field" class="section level2">
<h2>The [,, &lt;GROUP_BY&gt; ] field</h2>
<p>We can work out the average lap time over all these races (try this
yourself), but what about getting the average lap time for <em>each</em>
race? We need to perform something like <code>mean(seconds)</code>, but
do it separately for each unique entry in the <code>$year</code>
column.</p>
<p>This is known as <em>grouping</em>, in this case, grouping by
<code>$year</code>. And we use the <code>by=</code> argument in the
<GROUP_BY> field to provide a list of columns we wish to group by.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>ltA[ , <span class="fu">mean</span>(seconds) , by<span class="ot">=</span>.(year) ]</span></code></pre></div>
<pre><code>##     year        V1
##  1: 2011  95.61877
##  2: 2012  98.46993
##  3: 2013  94.95944
## ---               
## 20: 2009  97.42775
## 21: 2010 101.07681
## 22: 2017  91.10589</code></pre>
<p>Whoops! We never provided a column name so <code>data.table</code>
named it “V1”. Let’s fix that.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>ltA[ , .( <span class="at">mean_laptime =</span> <span class="fu">mean</span>(seconds) ) , by<span class="ot">=</span>.(year) ]</span></code></pre></div>
<pre><code>##     year mean_laptime
##  1: 2011     95.61877
##  2: 2012     98.46993
##  3: 2013     94.95944
## ---                  
## 20: 2009     97.42775
## 21: 2010    101.07681
## 22: 2017     91.10589</code></pre>
<p>And if we want to know the lap time per year per driver, we can group
on more variables …</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>ltA[ , .( <span class="at">mean_laptime =</span> <span class="fu">mean</span>(seconds) ) , by<span class="ot">=</span>.(year,fullname) ]</span></code></pre></div>
<pre><code>##      year         fullname mean_laptime
##   1: 2011 Sebastian Vettel     92.59067
##   2: 2011   Lewis Hamilton     92.97510
##   3: 2011      Mark Webber     93.24879
##  ---                                   
## 427: 2017  Marcus Ericsson     94.35571
## 428: 2017  Kevin Magnussen     93.98472
## 429: 2017 Daniel Ricciardo     98.88004</code></pre>
<p>… and perform multiple calculations …</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>ltA[ , .( <span class="at">mean_laptime =</span> <span class="fu">mean</span>(seconds) ,  <span class="at">fastest_lap =</span> <span class="fu">min</span>(seconds) ) , by<span class="ot">=</span>.(year,fullname) ]</span></code></pre></div>
<pre><code>##      year         fullname mean_laptime fastest_lap
##   1: 2011 Sebastian Vettel     92.59067      89.844
##   2: 2011   Lewis Hamilton     92.97510      90.314
##   3: 2011      Mark Webber     93.24879      89.600
##  ---                                               
## 427: 2017  Marcus Ericsson     94.35571      92.052
## 428: 2017  Kevin Magnussen     93.98472      87.568
## 429: 2017 Daniel Ricciardo     98.88004      89.447</code></pre>
<p>… and of course filter rows. Congratulations, we are now using all
three indexing fields together!</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>ltA[ year <span class="sc">&gt;</span> <span class="dv">2010</span> , .( <span class="at">mean_laptime =</span> <span class="fu">mean</span>(seconds) ,  <span class="at">fastest_lap =</span> <span class="fu">min</span>(seconds) ) , by<span class="ot">=</span>.(year,fullname) ]</span></code></pre></div>
<pre><code>##      year         fullname mean_laptime fastest_lap
##   1: 2011 Sebastian Vettel     92.59067      89.844
##   2: 2011   Lewis Hamilton     92.97510      90.314
##   3: 2011      Mark Webber     93.24879      89.600
##  ---                                               
## 136: 2017  Marcus Ericsson     94.35571      92.052
## 137: 2017  Kevin Magnussen     93.98472      87.568
## 138: 2017 Daniel Ricciardo     98.88004      89.447</code></pre>
<p>This is a great example of how quickly <code>data.table</code>
aggregates good stats for plotting. We can very quickly use the above
data to look at how average lap times evolve over seasons, for example
…</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggplot2)</span></code></pre></div>
<pre><code>## Loading required package: ggplot2</code></pre>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data=</span>ltA[ , .( <span class="at">mean_laptime =</span> <span class="fu">mean</span>(seconds) ,  <span class="at">fastest_lap =</span> <span class="fu">min</span>(seconds) ) , <span class="at">by=</span>.(year,fullname) ],</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping=</span><span class="fu">aes</span>(<span class="at">x=</span>year,<span class="at">y=</span>fastest_lap,<span class="at">colour=</span>fullname)</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="tutorial_data_table_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
</div>
<div id="getting-slightly-tricky" class="section level2">
<h2>Getting slightly tricky</h2>
<div id="initialise-a-new-data.table-from-scratch"
class="section level3">
<h3>Initialise a new data.table from scratch</h3>
<p>To make a <code>data.table</code> directly in R:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>newDt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">colCharacter =</span> <span class="fu">c</span>(<span class="st">&quot;h&quot;</span>,<span class="st">&quot;e&quot;</span>,<span class="st">&quot;l&quot;</span>,<span class="st">&quot;l&quot;</span>,<span class="st">&quot;o&quot;</span>,<span class="st">&quot;!&quot;</span>),</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">colInteger   =</span> 1L<span class="sc">:</span>2L,</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">colLogical   =</span> <span class="fu">c</span>(F,F,T)</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>newDt</span></code></pre></div>
<pre><code>##    colCharacter colInteger colLogical
## 1:            h          1      FALSE
## 2:            e          2      FALSE
## 3:            l          1       TRUE
## 4:            l          2      FALSE
## 5:            o          1      FALSE
## 6:            !          2       TRUE</code></pre>
<p>Notice the vectors you provide to fill the columns “recycle”, i.e.,
they repeat again and again until they match the length of the longest
vector. If they are not divisible evenly into that length
<code>data.table</code> will … actually that’s a good exercise, try it
and find out!</p>
</div>
<div id="group-by-with-.n" class="section level3">
<h3>Group by with .N</h3>
<p>Quite often you need to just count the members of each category, say,
the number of laps each driver has driven. You could write …</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>ltA[,.(<span class="at">N=</span>.N),by<span class="ot">=</span>.(surname)]</span></code></pre></div>
<pre><code>##         surname   N
##   1:     Vettel 430
##   2:   Hamilton 580
##   3:     Webber 525
##  ---               
## 101:     Stroll  40
## 102:  Vandoorne  55
## 103: Giovinazzi  55</code></pre>
<p><code>data.table</code> offers this shortcut …</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>ltA[,.N,by<span class="ot">=</span>.(surname)]</span></code></pre></div>
<p>… which will automatically name the count column “N”</p>
</div>
<div id="special-variable-.sd" class="section level3">
<h3>Special variable: <code>.SD</code></h3>
<p>Say you want to filter your <code>data.table</code> to select the
driver with the fastest lap in each race (or equivalently, filter BLAST
results, taking the highest-scoring alignment for each query … but this
is a strictly F1-based tutorial).</p>
<p>Naturally you will think about grouping by race. And about SELECTing
a row based on lap time. But the SELECT field acts on the <em>whole
table</em>, and you want to select from <em>each group</em>. What to
do?</p>
<p>When grouping, the special variable <code>.SD</code> gives you access
to a mini data.table containing just the group it is working on.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>ltA[,.SD[seconds<span class="sc">==</span><span class="fu">min</span>(seconds)],by<span class="ot">=</span>.(year)]</span></code></pre></div>
<pre><code>##     year forename      surname lap position                  name circuitId
##  1: 2011   Felipe        Massa  55        9 Australian_Grand_Prix         1
##  2: 2012   Jenson       Button  56        1 Australian_Grand_Prix         1
##  3: 2013     Kimi R\xcc_ikk̦nen  56        1 Australian_Grand_Prix         1
## ---                                                                        
## 20: 2009     Nico      Rosberg  48        7 Australian_Grand_Prix         1
## 21: 2010     Mark       Webber  47        6 Australian_Grand_Prix         1
## 22: 2017     Kimi R\xcc_ikk̦nen  56        4 Australian_Grand_Prix         1
##     seconds          fullname
##  1:  88.947      Felipe Massa
##  2:  89.187     Jenson Button
##  3:  89.274 Kimi R\xcc_ikk̦nen
## ---                          
## 20:  87.706      Nico Rosberg
## 21:  88.358       Mark Webber
## 22:  86.538 Kimi R\xcc_ikk̦nen</code></pre>
</div>
<div id="setorder" class="section level3">
<h3><code>setorder()</code> …</h3>
<p>We’ve already seen one method of ordering a <code>data.table</code>,
something like: <code>dt &lt;- dt[order(varname),]</code>. But this
requires copying the entire table, which is not memory efficient. To
sort the table more efficiently, we can use this function:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>ltA</span></code></pre></div>
<pre><code>##         forename   surname lap position                  name circuitId year
##     1: Sebastian    Vettel   1        1 Australian_Grand_Prix         1 2011
##     2: Sebastian    Vettel   2        1 Australian_Grand_Prix         1 2011
##     3: Sebastian    Vettel   3        1 Australian_Grand_Prix         1 2011
##    ---                                                                      
## 19843:    Daniel Ricciardo  23       17 Australian_Grand_Prix         1 2017
## 19844:    Daniel Ricciardo  24       17 Australian_Grand_Prix         1 2017
## 19845:    Daniel Ricciardo  25       17 Australian_Grand_Prix         1 2017
##        seconds         fullname
##     1:  98.109 Sebastian Vettel
##     2:  93.006 Sebastian Vettel
##     3:  92.713 Sebastian Vettel
##    ---                         
## 19843:  90.407 Daniel Ricciardo
## 19844:  89.466 Daniel Ricciardo
## 19845:  89.708 Daniel Ricciardo</code></pre>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setorder</span>(ltA,year,surname) <span class="co">#sort first by year, then by surname within each year</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>ltA</span></code></pre></div>
<pre><code>##         forename surname lap position                  name circuitId year
##     1:      Jean   Alesi   1        5 Australian_Grand_Prix         1 1996
##     2:      Jean   Alesi   2        5 Australian_Grand_Prix         1 1996
##     3:      Jean   Alesi   3        5 Australian_Grand_Prix         1 1996
##    ---                                                                    
## 19843: Sebastian  Vettel  55        1 Australian_Grand_Prix         1 2017
## 19844: Sebastian  Vettel  56        1 Australian_Grand_Prix         1 2017
## 19845: Sebastian  Vettel  57        1 Australian_Grand_Prix         1 2017
##        seconds         fullname
##     1: 106.506       Jean Alesi
##     2:  97.554       Jean Alesi
##     3:  96.830       Jean Alesi
##    ---                         
## 19843:  87.369 Sebastian Vettel
## 19844:  87.437 Sebastian Vettel
## 19845:  88.709 Sebastian Vettel</code></pre>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setorder</span>(ltA,year,<span class="sc">-</span>surname) <span class="co">#Use a negative sign to reverse the ordering</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>ltA</span></code></pre></div>
<pre><code>##        forename    surname lap position                  name circuitId year
##     1:  Jacques Villeneuve   1        1 Australian_Grand_Prix         1 1996
##     2:  Jacques Villeneuve   2        1 Australian_Grand_Prix         1 1996
##     3:  Jacques Villeneuve   3        1 Australian_Grand_Prix         1 1996
##    ---                                                                      
## 19843: Fernando     Alonso  48       10 Australian_Grand_Prix         1 2017
## 19844: Fernando     Alonso  49       10 Australian_Grand_Prix         1 2017
## 19845: Fernando     Alonso  50       10 Australian_Grand_Prix         1 2017
##        seconds           fullname
##     1: 103.702 Jacques Villeneuve
##     2:  97.036 Jacques Villeneuve
##     3:  95.959 Jacques Villeneuve
##    ---                           
## 19843:  90.077    Fernando Alonso
## 19844:  90.493    Fernando Alonso
## 19845:  92.485    Fernando Alonso</code></pre>
</div>
<div id="and-more-importantly-setkey" class="section level3">
<h3>… and more importantly, <code>setkey()</code></h3>
<p>There are computational advantages to having sorted tables. The
reason is the same reason dictionaries put the words in alphabetical
order and not randomly. When you search a dictionary for a word you
(probably without thinking about it) implement a kind of <a
href="https://en.wikipedia.org/wiki/Binary_search_algorithm">binary
search</a> algorithm. <code>data.table</code> is often asked to find
values, in fact that’s most of that the SELECT field does. If
<code>data.table</code> knows that one or more columns are sorted, it
can search them far more quickly. <code>setkey()</code> does this:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(ltA,forename,lap) <span class="co">#Note you cannot use `-` to reverse the order. That&#39;s why `setorder()` still exists</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="co">#This shows you that the data.table now has an attribute indicating which columns are sorted, or &quot;keys&quot;, in the lingo</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="fu">attributes</span>(ltA)[<span class="st">&quot;sorted&quot;</span>]</span></code></pre></div>
<pre><code>## $sorted
## [1] &quot;forename&quot; &quot;lap&quot;</code></pre>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setorder</span>(ltA,<span class="sc">-</span>year)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Obviously, if you reorder the rows later the keys will be removed.</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="fu">attributes</span>(ltA)[<span class="st">&quot;sorted&quot;</span>]</span></code></pre></div>
<pre><code>## $&lt;NA&gt;
## NULL</code></pre>
<p>This becomes especially super important when performing very large
merges, because these require a lot of searching behind the scenes to
work out what rows match.</p>
</div>
<div id="setnames" class="section level3">
<h3><code>setnames()</code></h3>
<p>This is a good way to change column names. The syntax is
<code>setnames(dataTable,c("vector","of","old","names"),c("VECTOR","OF","NEW","NAMES"))</code></p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(newDt)</span></code></pre></div>
<pre><code>## [1] &quot;colCharacter&quot; &quot;colInteger&quot;   &quot;colLogical&quot;</code></pre>
<div class="sourceCode" id="cb101"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(newDt,<span class="fu">c</span>(<span class="st">&quot;colCharacter&quot;</span>,<span class="st">&quot;colInteger&quot;</span>),<span class="fu">c</span>(<span class="st">&quot;colChar&quot;</span>,<span class="st">&quot;colInt&quot;</span>))</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(newDt)</span></code></pre></div>
<pre><code>## [1] &quot;colChar&quot;    &quot;colInt&quot;     &quot;colLogical&quot;</code></pre>
<div class="sourceCode" id="cb103"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># I like to use it in conjunction with magrittr pipes (if you don&#39;t get this command don&#39;t worry, magrittr can be a tutorial for another day)</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(magrittr)</span></code></pre></div>
<pre><code>## Loading required package: magrittr</code></pre>
<div class="sourceCode" id="cb105"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>newDt <span class="sc">%&gt;%</span> <span class="fu">setnames</span>(<span class="fu">colnames</span>(.),LETTERS[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">ncol</span>(.))])</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>newDt</span></code></pre></div>
<pre><code>##    A B     C
## 1: h 1 FALSE
## 2: e 2 FALSE
## 3: l 1  TRUE
## 4: l 2 FALSE
## 5: o 1 FALSE
## 6: ! 2  TRUE</code></pre>
</div>
<div id="setdt" class="section level3">
<h3><code>setDT()</code></h3>
<p>Similar to functions like <code>as.matrix()</code> and
<code>as.data.frame()</code>, there is an <code>as.data.table()</code>
function that will attempt to convert other objects into
<code>data.table</code>s. This requires a lot of copying of data behind
the scenes. Unless, of course, the object you are converting is a
<code>data.frame</code> because as we discussed, a
<code>data.table</code> is just an extension of a
<code>data.frame</code>. To really bring that home:</p>
<div class="sourceCode" id="cb107"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(newDt) <span class="co">#See? It&#39;s classed as a data.table AND a data.frame</span></span></code></pre></div>
<pre><code>## [1] &quot;data.table&quot; &quot;data.frame&quot;</code></pre>
<p>So, why bother copying? <code>setDT(dataFrame)</code> will instantly
convert a <code>dataFrame</code> into a <code>data.table</code> with
almost zero extra memory or processing required.</p>
<p>This and the other “set” functions above all save memory using this
this zero-copying paradigm, so now is a good time to talk about that
more generally.</p>
<div id="pass-by-reference-the-key-to-speed-and-memory-efficiency"
class="section level4">
<h4>Pass by reference, the key to speed and memory efficiency</h4>
<p><strong>This is technical background</strong>, feel free to skip it.
But as you get more advanced with R, it will become very important.</p>
<p>Normally, when you pass a function an object in R, the function makes
a copy of the object and works on the copy (oversimplified but, in
general that’s true). Copying data is inefficient, but can help programs
to act “safely”, since you are less likely to end up accidentally
modifying an object you don’t want to. This paradigm is known as
<em>copy on modify semantics</em>.</p>
<p><code>data.table</code> avoids making copies unless absolutely
necessary. This is partly why it is so much faster and uses less memory
than the same operations in tidyverse packages. It also bears some
risks. Consider this function that involves adding a column to a
<code>data.table</code>:</p>
<div class="sourceCode" id="cb109"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>addCol <span class="ot">&lt;-</span> <span class="cf">function</span>(dt){</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>  dt[,newCol<span class="sc">:</span><span class="er">=</span><span class="dv">1</span><span class="sc">:</span>.N]</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>If we run this on <code>newDt</code> as defined above, nothing (well
… NULL) is returned. But look at the table before and after!</p>
<div class="sourceCode" id="cb110"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(newDt)</span></code></pre></div>
<pre><code>## [1] &quot;A&quot; &quot;B&quot; &quot;C&quot;</code></pre>
<div class="sourceCode" id="cb112"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">addCol</span>(newDt)</span></code></pre></div>
<pre><code>## NULL</code></pre>
<div class="sourceCode" id="cb114"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(newDt)</span></code></pre></div>
<pre><code>## [1] &quot;A&quot;      &quot;B&quot;      &quot;C&quot;      &quot;newCol&quot;</code></pre>
<p>As you can see, even though we never specifically over-wrote our
original table, it has been modified. that is because the walrus
operator function (<code>:=</code>), like many <code>data.table</code>
functions, uses <em>reference semantics</em>, that is, it is passed the
memory address of the actual original table, which it them modifies. So
you have to be careful. Other <code>data.table</code> operations will
indeed copy part of or the whole table, but always aims to optimise
speed and memory usage without being too risky. I mean … there’s no real
harm in having an extra column floating around, but imagine if we
deleted a column! That could actually be a problem. Be alert but not
alarmed.</p>
</div>
</div>
<div id="multiline-do_something" class="section level3">
<h3>Multiline DO_SOMETHING</h3>
<p>DO_SOMETHING can get very complex. Use curly braces (<code>{</code>
and <code>}</code>) to denote multi-command operations in there. I
speculate that a driver’s fastest lap of a race is usually a few laps
before the last lap, when they are pushing the car hard but the tyres
have not yet worn out too much. Let’s check how many laps from the end
of the race drivers normally complete their fastest lap of the race.</p>
<div class="sourceCode" id="cb116"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>fastLapDt <span class="ot">&lt;-</span> lt[,{</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  lastLap <span class="ot">&lt;-</span> <span class="fu">max</span>(lap)</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  verstappenFastest <span class="ot">&lt;-</span> .SD[,lap[milliseconds<span class="sc">==</span><span class="fu">min</span>(milliseconds)]]</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>  .( <span class="at">lapsBeforeLastFastest =</span> verstappenFastest <span class="sc">-</span> lastLap )</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>},by<span class="ot">=</span>.(circuitId,year)]</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>( fastLapDt<span class="sc">$</span>lapsBeforeLastFastest, <span class="at">breaks=</span><span class="cf">function</span>(x){<span class="fu">min</span>(x)<span class="sc">:</span><span class="dv">0</span>} )</span></code></pre></div>
<p><img src="tutorial_data_table_files/figure-html/unnamed-chunk-39-1.png" width="672" /></p>
<p>Yep, looks like it’s most often the second to last lap, but by a tiny
margin.</p>
<p>Take some time to make sure you understand every part of this
command, it contains many tricks and is a good recap of the tutorial so
far.</p>
<p>Want a fun challenge? Figure out a way to do this with one line.</p>
<div id="use-as-a-for-loop" class="section level4">
<h4>Use as a <em>for</em> loop</h4>
<p>The GROUP_BY field effectively runs a set of commands for each group.
When you think about it, that’s quite similar to what a
<code>for(){ ... }</code> loop does. R for-loops are <a
href="https://towardsdatascience.com/r-is-slow-and-its-your-fault-2fcedacc7abb">famously
slow</a>. There’s a fascinating history as to why, it’s partially on
purpose to encourage you to use faster alternatives. <a
href="https://www.guru99.com/r-apply-sapply-tapply.html"><code>*ply</code>-type
functions</a> are good, but using <code>data.table</code>s to mimic
for-loops, as we have done above, is even faster.</p>
<p>You can even modify a variable outside the <code>data.table</code>
while it is “looping”, using the <a
href="https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/assignOps"><code>&lt;&lt;-</code>
operator</a>.</p>
</div>
</div>
</div>
<div id="getting-extra-tricky" class="section level2">
<h2>Getting extra tricky</h2>
<div id="special-variable-.grp" class="section level3">
<h3>Special variable: <code>.GRP</code></h3>
<p>When you GROUP_BY, the groups are given a number you can access with
the special variable .GRP. I can’t think of a use case right now but
remember it, it does occasionally come in very handy.</p>
</div>
</div>
</div>
<div id="casting-and-melting" class="section level1">
<h1>Casting and melting</h1>
<p>It’s very common to want to <em>pivot</em> a table from
<strong>wide</strong> to <strong>long</strong> form or back.
Intuitively, wide is like this:</p>
<table>
<thead>
<tr class="header">
<th align="left">Driver</th>
<th align="left">Lap 1</th>
<th align="left">Lap 2</th>
<th align="left">Lap 3</th>
<th align="left">Lap 4</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Driver 1</td>
<td align="left">1:18.5</td>
<td align="left">1:18.2</td>
<td align="left">1:17.9</td>
<td align="left">1:18.2</td>
</tr>
<tr class="even">
<td align="left">Driver 2</td>
<td align="left">1:17.2</td>
<td align="left">1:17.0</td>
<td align="left">1:16.5</td>
<td align="left">1:17.2</td>
</tr>
<tr class="odd">
<td align="left">Driver 3</td>
<td align="left">1:18.8</td>
<td align="left">1:17.1</td>
<td align="left">1:18.4</td>
<td align="left">1:20.0</td>
</tr>
<tr class="even">
<td align="left">Driver 4</td>
<td align="left">1:19.1</td>
<td align="left">1:17.0</td>
<td align="left">1:15.9</td>
<td align="left">1:20.2</td>
</tr>
</tbody>
</table>
<p>… and long would be like this:</p>
<table>
<thead>
<tr class="header">
<th align="left">Driver</th>
<th align="left">Lap</th>
<th align="left">Time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Driver 1</td>
<td align="left">Lap 1</td>
<td align="left">1:18.5</td>
</tr>
<tr class="even">
<td align="left">Driver 1</td>
<td align="left">Lap 2</td>
<td align="left">1:18.2</td>
</tr>
<tr class="odd">
<td align="left">Driver 1</td>
<td align="left">Lap 3</td>
<td align="left">1:17.9</td>
</tr>
<tr class="even">
<td align="left">Driver 1</td>
<td align="left">Lap 4</td>
<td align="left">1:18.2</td>
</tr>
<tr class="odd">
<td align="left">Driver 2</td>
<td align="left">Lap 1</td>
<td align="left">1:17.2</td>
</tr>
<tr class="even">
<td align="left">Driver 2</td>
<td align="left">Lap 2</td>
<td align="left">1:17.0</td>
</tr>
<tr class="odd">
<td align="left">Driver 2</td>
<td align="left">Lap 3</td>
<td align="left">1:16.5</td>
</tr>
<tr class="even">
<td align="left">etc …</td>
<td align="left">—</td>
<td align="left">—</td>
</tr>
</tbody>
</table>
<p>Changing the <em>shape</em> of data from wide to long is called
<em>melting</em> (picture melting cheese dripping from a Vegemite
jaffel, creating long vertical strings [rows]). Long –&gt; wide is
called <em>casting</em> in a poorly executed attempt to maintain
semantic symmetry with its counterpart.</p>
<p>Shapeshifting requires some interesting syntax. Going from long to
wide is (contrary to popular opinion) easier. You want a kind of grid,
right? So just specify the variable whose levels should be represented
on each axis of the grid. In this case you would specify that the
drivers should be on the row axis, and the laps should be on the column
axis.</p>
<div id="casting" class="section level2">
<h2>Casting</h2>
<p>Here’s a demo, using <code>data.table</code>s casting function
<code>dcast()</code>.</p>
<div class="sourceCode" id="cb117"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>ltA17LapTimes <span class="ot">&lt;-</span> ltA[year<span class="sc">==</span><span class="dv">2017</span>,.(<span class="at">Driver=</span>fullname,lap,seconds)]</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ltA17LapTimes)</span></code></pre></div>
<pre><code>##                  Driver lap seconds
##   1: Antonio Giovinazzi   1 107.489
##   2: Antonio Giovinazzi   2  94.891
##   3: Antonio Giovinazzi   3  93.874
##  ---                               
## 940:    Valtteri Bottas  55  88.670
## 941:    Valtteri Bottas  56  86.593
## 942:    Valtteri Bottas  57  87.507</code></pre>
<div class="sourceCode" id="cb119"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>ltA17LapTimesCast <span class="ot">&lt;-</span> <span class="fu">dcast</span>(ltA17LapTimes, <span class="at">formula =</span> Driver <span class="sc">~</span> lap)</span></code></pre></div>
<pre><code>## Using &#39;seconds&#39; as value column. Use &#39;value.var&#39; to override</code></pre>
<div class="sourceCode" id="cb121"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ltA17LapTimesCast[,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span></code></pre></div>
<pre><code>##                 Driver       1      2      3      4
##  1: Antonio Giovinazzi 107.489 94.891 93.874 94.121
##  2:       Carlos Sainz 101.891 91.386 91.658 90.646
##  3:   Daniel Ricciardo 296.773 92.510 91.619 92.111
## ---                                                
## 18:        Sergio P̩rez 102.868 91.589 91.539 91.043
## 19:  Stoffel Vandoorne 106.762 94.509 93.571 93.110
## 20:    Valtteri Bottas  96.009 90.141 89.635 89.301</code></pre>
<div class="sourceCode" id="cb123"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">heatmap</span>(ltA17LapTimesCast[,<span class="sc">-</span><span class="st">&quot;Driver&quot;</span>] <span class="sc">%&gt;%</span> as.matrix,<span class="at">Rowv =</span> <span class="cn">NA</span>,<span class="at">Colv =</span> <span class="cn">NA</span>,<span class="at">labRow =</span> <span class="fu">iconv</span>(ltA17LapTimesCast<span class="sc">$</span>Driver))</span></code></pre></div>
<p><img src="tutorial_data_table_files/figure-html/unnamed-chunk-40-1.png" width="672" /></p>
<p>So that worked but we had a warning:</p>
<p><strong>“Using ‘seconds’ as value column. Use ‘value.var’ to
override”</strong></p>
<p>This is for a very good reason. Casting creates a grid. We told the
function what variables (AKA columns) should define the rows and columns
of the grid. But we didn’t specify which column should be used to put
values in the grid. In this case was asked for a grid defined by drivers
and laps, there was only one column (“seconds”) left over to provide
values for the grid. But it <a
href="https://www.youtube.com/watch?v=u1eSiso7VZs">ain’t necessarily
so</a>. There will often be many columns to choose from, and you need to
specify which is the value-filling columns using the argument
<code>value.var=...</code>.</p>
<p>A related case that comes up often is that there isn’t one unique (to
use this example) lap column for each driver, or vice versa. For
example, if there were two rows recording a time for the driver “Carlos
Sainz” in lap 4, which one should provide the “seconds” to fill the grid
position corresponding to that driver/lap combination? One option would
be to, say, just take all the candidate rows and add their values
together. In this case, adding would be a form of <em>aggregation</em> —
a way of compressing multiple values into one. Faced with multiple
values per grid item, <code>data.table</code> will ask you to provide a
function to use for aggregation.</p>
</div>
<div id="melt" class="section level2">
<h2>Melt</h2>
<p>Melt is (sort of) the opposite of cast. So we’ll use it to (sort of)
recover the original table from the one we just produced. We can’t
normally recover the <strong>exact</strong> table, because some
information is normally lost in casting (for example, by aggregating
multiple values into one). But in this instance we can!</p>
<p>If you look at those two tables above and think about how you would
convert wide to long, you might notice there are some bits of
information that need to be given.</p>
<ol style="list-style-type: decimal">
<li>Which columns should provide data to be compressed into the new
column? ( “1” , “2” , “3” , … )</li>
<li>There will be a new column that tells you what original column the
data came from. What should that be called? (“Lap”)</li>
<li>What should the new column of data be called? (“Time”)</li>
</ol>
<p>You provide this information in arguments to <code>melt()</code>,
using the arguments <code>measure.vars</code> (1),
<code>value.name</code> (2), and <code>variable.name</code> (2):</p>
<div class="sourceCode" id="cb124"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We want to melt all the columns besides the first one, so let&#39;s make a list of their names (&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, ...)</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>meltVars <span class="ot">&lt;-</span> <span class="fu">colnames</span>(ltA17LapTimesCast)[<span class="sc">-</span><span class="dv">1</span>] <span class="co"># Do you know this trick? Cool, right?</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="fu">melt</span>(ltA17LapTimesCast,<span class="at">measure.vars=</span>meltVars,<span class="at">value.name=</span><span class="st">&quot;Lap&quot;</span>,<span class="at">variable.name=</span><span class="st">&quot;Time&quot;</span>)</span></code></pre></div>
<pre><code>##                   Driver Time     Lap
##    1: Antonio Giovinazzi    1 107.489
##    2:       Carlos Sainz    1 101.891
##    3:   Daniel Ricciardo    1 296.773
##   ---                                
## 1138:        Sergio P̩rez   57      NA
## 1139:  Stoffel Vandoorne   57      NA
## 1140:    Valtteri Bottas   57  87.507</code></pre>
<p>Casting and melting come up all the time in genetics. For example,
imagine having a list of gene expression values with a column for
‘treatment’. You’d likely want to turn that into a matrix and plot it,
so <code>dcast</code> would come into play. They are tricky operations,
but they make more sense once you have a use case of your own.</p>
</div>
</div>
<div id="helpful-functions" class="section level1">
<h1>Helpful functions</h1>
<div id="foverlaps" class="section level2">
<h2>foverlaps</h2>
</div>
<div id="fifelse" class="section level2">
<h2>fifelse</h2>
</div>
<div id="frank" class="section level2">
<h2>frank</h2>
</div>
<div id="frollapply" class="section level2">
<h2>frollapply</h2>
</div>
<div id="fintersect" class="section level2">
<h2>fintersect</h2>
</div>
<div id="fcoalesce" class="section level2">
<h2>fcoalesce</h2>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
